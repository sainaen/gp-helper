<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>GP Helper</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script>
        function isByteString(str) {
            return str.length % 2 == 0 && /^[0-9a-fA-F]+$/.test(str);
        }

        function splitIntoBytes(str) {
            var result = [];
            while (str) {
                result.push(parseInt(str.substr(0, 2), 16));
                str = str.substr(2);
            }
            return result;
        }

        function formAPDU(bytes) {
            var apdu = {};
            if (!bytes[0] || (bytes[0] & 0x80) == 0) {
                throw new Error("Not a GP Card Command!");
            }
            apdu.cla = bytes[0];
            if ((bytes[0] & 0x04) != 0) {
                apdu.security = true;
            }
            apdu.ins = bytes[1];
            apdu.p1 = bytes[2];
            apdu.p2 = bytes[3];
            apdu.lc = bytes[4];
            if (apdu.security) {
                // mac is included in Lc
                apdu.mac = bytes.slice(5 + apdu.lc - 8, 5 + apdu.lc);
            }
            apdu.data = bytes.slice(5, 5 + apdu.lc - (apdu.mac ? apdu.mac.length : 0));
            var additionalLen = bytes.length - 5 - apdu.lc;
            if (additionalLen > 1) {
                throw new Error("Wrong Lc!");
            }
            if (additionalLen == 1) {
                apdu.le = bytes[5 + apdu.lc + (apdu.mac ? apdu.mac.length : 0)];
            }
            return apdu;
        }

        function formatByte(byte) {
            var digits = "0123456789ABCDEF";
            return "0x" + digits.charAt(byte >> 4) + digits.charAt(byte & 0x0F);
        }

        function padToByte(n) {
            while (n.length < 8) {
                n = "0" + n;
            }
            return n;
        }

        function formatBitmask(byte) {
            return formatByte(byte) + (byte ? " (bits set: " + padToByte(byte.toString(2)).split("").reverse().reduce(function (result, bit, idx) {
                if (bit == "1") {
                    result += (result.length > 0 ? ", " : "") + idx;
                }
                return result;
            }, "") + ")" : "");
        }

        function formatByteArray(bytes) {
            if (bytes.length > 14) {
                return "[" + bytes.slice(0, 10).map(formatByte).join(", ") + ", ..., " + bytes.slice(-4).map(formatByte).join(", ") + "] (len: " + bytes.length + ")";
            }
            return "[" + bytes.map(formatByte).join(", ") + "] (len: " + bytes.length + ")";
        }

        function formatAPDU(apdu) {
            var text = "\n\tCLA:\t" + formatByte(apdu.cla) +
                "\n\tINS:\t" + formatBitmask(apdu.ins) +
                "\n\tP1:\t" + formatBitmask(apdu.p1) +
                "\n\tP2:\t" + formatBitmask(apdu.p2) +
                "\n\tLc:\t" + formatByte(apdu.lc) + " (" + apdu.lc + ")" +
                "\n\tData:\t" + formatByteArray(apdu.data);
            if ("mac" in apdu) {
                text += "\n\tMAC:\t" + formatByteArray(apdu.mac);
            }
            if ("le" in apdu) {
                text += "\n\tLe:\t" + formatByte(apdu.le)
            }
            return text;
        }

        $(function () {
            // onload
            var $in = $("#in");
            var $out = $("#out");
            $("#inForm").on("submit", function (e) {
                e.preventDefault();
                var inStr = $in.val().trim();
                if (!inStr) {
                    $out.text("Empty input!");
                    return;
                }
                if (!isByteString(inStr)) {
                    $out.text("Not a ByteString!");
                    return;
                }
                try {
                    var bytes = splitIntoBytes(inStr);
                    var apdu = formAPDU(bytes);
                    $out.text("APDU:" + formatAPDU(apdu) + "\n");

                } catch (ex) {
                    console.error(ex);
                    $out.text(ex);
                }
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="row">
            <h3>GP Helper</h3>
        </div>
        <div class="row">
            <form action="#" role="form" id="inForm">
                <div class="form-group">
                    <input id="in" class="form-control" name="in" type="text" placeholder="Paste APDU here"/>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-default">Press here</button>
                </div>
            </form>
        </div>

        <div class="row" id="outBlock">
            <pre id="out">Output will be here</pre>
        </div>
    </div>
</body>
</html>
