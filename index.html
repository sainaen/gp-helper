<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>GP Helper</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script>
        function isByteString(str) {
            return str.length % 2 == 0 && /^[0-9a-fA-F]+$/.test(str);
        }

        function splitIntoBytes(str) {
            var result = [];
            while (str) {
                result.push(parseInt(str.substr(0, 2), 16));
                str = str.substr(2);
            }
            return result;
        }

        function isSW(bytes) {
            return bytes.length == 2;
        }

        function isGpAPDU(bytes) {
            return bytes[0] & 0x80 && bytes.length > 4;
        }

        function isSelectAPDU(bytes) {
            return bytes[0] == 0 && bytes[1] == 0xA4 && bytes[2] == 0x04;
        }

        function formAPDU(bytes) {
            var apdu = {};
            if (!bytes[0] || (bytes[0] & 0x80) == 0) {
                throw new Error("Not a GP Card Command!");
            }
            apdu.cla = bytes[0];
            if ((bytes[0] & 0x04) != 0) {
                apdu.security = true;
            }
            apdu.ins = bytes[1];
            apdu.p1 = bytes[2];
            apdu.p2 = bytes[3];
            apdu.lc = bytes[4];
            if (apdu.security) {
                // mac is included in Lc
                apdu.mac = bytes.slice(5 + apdu.lc - 8, 5 + apdu.lc);
            }
            apdu.data = bytes.slice(5, 5 + apdu.lc - (apdu.mac ? apdu.mac.length : 0));
            var additionalLen = bytes.length - 5 - apdu.lc;
            if (additionalLen > 1) {
                throw new Error("Wrong Lc!");
            }
            if (additionalLen == 1) {
                apdu.le = bytes[5 + apdu.lc + (apdu.mac ? apdu.mac.length : 0)];
            }
            return apdu;
        }

        function formatByteSimple(byte) {
            var digits = "0123456789ABCDEF";
            return digits.charAt(byte >> 4) + digits.charAt(byte & 0x0F);
        }

        function formatByte(byte) {
            return "0x" + formatByteSimple(byte);
        }

        function padToByte(n) {
            while (n.length < 8) {
                n = "0" + n;
            }
            return n;
        }

        function formatBitmask(byte) {
            return formatByte(byte) + (byte ? " (bits set: " + padToByte(byte.toString(2)).split("").reverse().reduce(function (result, bit, idx) {
                if (bit == "1") {
                    result += (result.length > 0 ? ", " : "") + idx;
                }
                return result;
            }, "") + ")" : " (bits set: none)");
        }

        function formatByteArray(bytes) {
            if (bytes.length > 14) {
                return "[" + bytes.slice(0, 10).map(formatByte).join(", ") + ", <a class='more' style='cursor: pointer' data-bytes='" + JSON.stringify(bytes.slice(10, -4)) + "'>...</a>, " + bytes.slice(-4).map(formatByte).join(", ") + "] (len: " + bytes.length + ")";
            }
            return "[" + bytes.map(formatByte).join(", ") + "] (len: " + bytes.length + ")";
        }

        function formatINS(byte) {
            var inses = {
                0xE4: "Delete",
                0xF2: "Get Status",
                0xE6: "Install",
                0xE8: "Load",
                0x70: "Manage Channel",
                0xD8: "Put Key",
                0xA4: "Select",
                0xF0: "Set Status",
                0xE2: "Store Data",
                0x50: "Initialize Update",
                0x82: "External Authenticate",
                0x7A: "Begin R-MAC Session",
                0x78: "End R-MAC Session",
                0x84: "Get Challenge",
                0xCA: "Get Data",
                0xCB: "Get Data",
                0x88: "Internal Authenticate",
                0x22: "Manage Security Environment",
                0x2A: "Perform Security Operation [decipher]"
            };
            var name = inses[byte];
            return formatByte(byte) + " (" + (name || "Unknown INS") + ")";
        }

        function formatGenericAPDU(apdu) {
            var text = "\n\tCLA:\t" + formatByte(apdu.cla) +
                "\n\tINS:\t" + formatINS(apdu.ins) +
                "\n\tP1:\t" + formatBitmask(apdu.p1) +
                "\n\tP2:\t" + formatBitmask(apdu.p2) +
                "\n\tLc:\t" + formatByte(apdu.lc) + " (" + apdu.lc + ")" +
                "\n\tData:\t" + formatByteArray(apdu.data);
            if ("mac" in apdu) {
                text += "\n\tMAC:\t" + formatByteArray(apdu.mac);
            }
            if ("le" in apdu) {
                text += "\n\tLe:\t" + formatByte(apdu.le)
            }
            return text;
        }

        function formatAPDU(apdu) {
            var knownAPDUFormaters = {};

            return (knownAPDUFormaters[apdu.ins] ? knownAPDUFormaters[apdu.ins](apdu) : formatGenericAPDU(apdu));
        }

        function formatSW(bytes) {
            var sws = [
                {sw1: 0x90, sw2: 0x00, title: "Success"},
                {sw1: 0x61, sw2: -1, title: "Response data incomplete, more bytes available"},
                {sw1: 0x62, sw2: 0x00, title: "Logical Channel already closed (manage channel)"},
                {sw1: 0x62, sw2: 0x83, title: "Card Life Cycle State is CARD_LOCKED (select)"},
                {sw1: 0x63, sw2: 0x00, title: "External auth: Authentication of host cryptogram failed, or Verification of certificate failed"},
                {sw1: 0x63, sw2: 0x10, title: "More data available (get status)"},
                {sw1: 0x64, sw2: 0x00, title: "No specific diagnosis"},
                {sw1: 0x65, sw2: 0x81, title: "Memory failure"},
                {sw1: 0x67, sw2: 0x00, title: "Wrong length in Lc"},
                {sw1: 0x68, sw2: 0x81, title: "Logical channel not supported or is not active"},
                {sw1: 0x68, sw2: 0x82, title: "Secure messaging not supported (manage channel, select)"},
                {sw1: 0x68, sw2: 0x83, title: "The last command of the chain was expected (perform security operation)"},
                {sw1: 0x69, sw2: 0x82, title: "Security status not satisfied"},
                {sw1: 0x69, sw2: 0x85, title: "Conditions of use not satisfied"},
                {sw1: 0x6A, sw2: 0x80, title: "Incorrect values in command data (delete, get status, install, set status, store data, internal auth)"},
                {sw1: 0x6A, sw2: 0x81, title: "Function not supported e.g. card Life Cycle State is CARD_LOCKED (manage channel, select)"},
                {sw1: 0x6A, sw2: 0x82, title: "Application/file not found (delete, select)"},
                {sw1: 0x6A, sw2: 0x84, title: "Not enough memory space (install, load, put key, store data)"},
                {sw1: 0x6A, sw2: 0x86, title: "Incorrect P1 P2"},
                {sw1: 0x6A, sw2: 0x88, title: "Referenced data not found (delete, get data, get status, install, put key, set status, store data, init update, begin/end r-mac session)"},
                {sw1: 0x6D, sw2: 0x00, title: "Invalid instruction"},
                {sw1: 0x6E, sw2: 0x00, title: "Invalid class"},
                {sw1: 0x94, sw2: 0x84, title: "Algorithm not supported (put key, external auth)"},
                {sw1: 0x94, sw2: 0x85, title: "Invalid key check value (put key)"}
            ];
            function findSW(bytes) {
                var generic;
                for (var i = 0; i < sws.length; i++) {
                    if (sws[i].sw1 === bytes[0]) {
                        if (sws[i].sw2 == -1) {
                            generic = sws[i];
                        } else if (sws[i].sw2 === bytes[1]) {
                            return sws[i];
                        }
                    }
                }
                if (generic) {
                    return generic;
                }
                throw new Error("Unknown SW!");
            }

            return findSW(bytes).title;
        }

        function formatAID(bytes) {
            return bytes.map(formatByteSimple).join("");
        }

        function formatSelectAPDU(bytes) {
            var lc = bytes[4];
            return "Select AID " + formatAID(bytes.slice(5, 5+lc));
        }

        $(function () {
            // onload
            var $in = $("#in");
            var $out = $("#out");
            var $inForm = $("#inForm");
            $inForm.on("submit", function (e) {
                e.preventDefault();
                var inStr = $in.val().trim();
                if (!inStr) {
                    $out.text("Empty input!");
                    return;
                }
                if (!isByteString(inStr)) {
                    $out.text("Not a ByteString!");
                    return;
                }
                if (history.pushState) {
                    history.pushState(null, null, "#" + inStr);
                } else {
                    location.hash = "#" + inStr;
                }
                try {
                    var bytes = splitIntoBytes(inStr);
                    if (isGpAPDU(bytes)) {
                        $out.html("APDU: " + formatAPDU(formAPDU(bytes)) + "\n");
                        return;
                    }
                    if (isSelectAPDU(bytes)) {
                        $out.html("APDU: " + formatSelectAPDU(bytes) + "\n");
                        return;
                    }
                    if (isSW(bytes)){
                        $out.html("Status Word: " + formatSW(bytes) + "\n");
                        return;
                    }
                    $out.html("Unknown input!");
                } catch (ex) {
                    console.error(ex);
                    $out.html(ex);
                }
            });
            $out.on("click", ".more", function (e) {
                var $more = $(e.target);
                var bytes = $more.data("bytes");
                $more.replaceWith(bytes.map(formatByte).join(", "));
            });
            if (window.location.hash) {
                $in.val(window.location.hash.substr(1));
                $inForm.submit();
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="row">
            <h3>GP Helper</h3>
        </div>
        <div class="row">
            <form action="#" role="form" id="inForm">
                <div class="form-group">
                    <input id="in" class="form-control" name="in" type="text" placeholder="Paste APDU or SW here"/>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-default">Press here</button>
                </div>
            </form>
        </div>

        <div class="row" id="outBlock">
            <pre id="out">Output will be here</pre>
        </div>
    </div>
</body>
</html>
